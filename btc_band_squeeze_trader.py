#!/usr/bin/env python3
"""
üî• BTC BAND SQUEEZE DETECTOR
Bollinger Bands tightening = Major move incoming
"""

import json
from coinbase.rest import RESTClient
import time
from datetime import datetime

config = json.load(open("/home/dereadi/.coinbase_config.json"))
key = config["api_key"].split("/")[-1]
client = RESTClient(api_key=key, api_secret=config["api_secret"])

print("‚ö° BTC BOLLINGER BAND SQUEEZE ALERT")
print("=" * 60)
print(f"Time: {datetime.now().strftime('%I:%M %p CST')}")
print("=" * 60)

# Get BTC price
ticker = client.get_product("BTC-USD")
btc_price = float(ticker["price"])

# Get recent candles for volatility calculation
import time as time_module
end_time = int(time_module.time())
start_time = end_time - (20 * 300)  # 20 five-minute candles
candles = client.get_candles("BTC-USD", start_time, end_time, "FIVE_MINUTE")
prices = []

if candles["candles"]:
    for candle in candles["candles"]:
        prices.append(float(candle["close"]))
    
    # Calculate simple band width
    import statistics
    mean_price = statistics.mean(prices)
    std_dev = statistics.stdev(prices)
    
    upper_band = mean_price + (2 * std_dev)
    lower_band = mean_price - (2 * std_dev)
    band_width = upper_band - lower_band
    band_width_pct = (band_width / mean_price) * 100
    
    print(f"üéØ BTC Current: ${btc_price:,.2f}")
    print(f"üìä 20-period Mean: ${mean_price:,.2f}")
    print(f"üìà Upper Band: ${upper_band:,.2f}")
    print(f"üìâ Lower Band: ${lower_band:,.2f}")
    print(f"üîß Band Width: ${band_width:,.2f} ({band_width_pct:.2f}%)")
    print("-" * 60)
    
    # Position in bands
    position_in_bands = (btc_price - lower_band) / band_width if band_width > 0 else 0.5
    
    print(f"üìç Position in Bands: {position_in_bands:.1%}")
    
    # SQUEEZE DETECTION
    if band_width_pct < 1.5:  # Very tight bands
        print("\n‚ö°‚ö°‚ö° EXTREME SQUEEZE DETECTED ‚ö°‚ö°‚ö°")
        print("MAJOR MOVE IMMINENT!")
        
        # Deploy capital for the breakout
        accounts = client.get_accounts()["accounts"]
        usd_balance = 0
        for acc in accounts:
            if acc["currency"] == "USD":
                usd_balance = float(acc["available_balance"]["value"])
                break
        
        print(f"\nAvailable USD: ${usd_balance:.2f}")
        
        if usd_balance > 50:
            print("\nüöÄ PREPARING BREAKOUT TRADES:")
            
            # Set both sides ready
            print("  ‚Ä¢ Set BUY order above upper band")
            print("  ‚Ä¢ Set SELL order below lower band")
            print("  ‚Ä¢ Whichever triggers first = direction")
            
            # Place small probe trade
            try:
                probe_size = min(50, usd_balance * 0.3)
                order = client.market_order_buy(
                    client_order_id=f"btc_squeeze_probe_{int(time.time()*1000)}",
                    product_id="BTC-USD",
                    quote_size=str(probe_size)
                )
                print(f"\n‚úÖ Probe position established: ${probe_size:.2f}")
                print(f"  ‚Ä¢ If breaks UP ‚Üí Add to position")
                print(f"  ‚Ä¢ If breaks DOWN ‚Üí Quick stop and reverse")
            except Exception as e:
                print(f"Probe order failed: {e}")
                
    elif band_width_pct < 2.5:
        print("\n‚ö° SQUEEZE FORMING")
        print("Bands tightening - prepare for volatility")
    else:
        print("\nüìä Normal band width - no squeeze yet")

# Check other correlated assets
print("\nüîó CORRELATED ASSETS CHECK:")
print("-" * 60)

for coin in ["ETH", "SOL"]:
    try:
        ticker = client.get_product(f"{coin}-USD")
        price = float(ticker["price"])
        print(f"{coin}: ${price:.2f} - Watch for sympathy move")
    except:
        pass

# Alert the specialists
print("\nü§ñ DEPLOYING SQUEEZE SPECIALISTS:")
print("-" * 60)

specialist_config = {
    "mode": "SQUEEZE_BREAKOUT",
    "target": "BTC",
    "band_width": band_width_pct if 'band_width_pct' in locals() else 0,
    "timestamp": datetime.now().isoformat()
}

with open("/tmp/squeeze_alert.json", "w") as f:
    json.dump(specialist_config, f)

print("‚úÖ Volatility specialists alerted")
print("‚úÖ Breakout specialists on standby")
print("‚úÖ Flywheel ready for momentum capture")

# Strategy recommendation
print("\nüìã SQUEEZE PLAY STRATEGY:")
print("-" * 60)
if 'band_width_pct' in locals() and band_width_pct < 2:
    print("1. ‚ö° IMMEDIATE: Establish small probe position")
    print("2. üìä WATCH: Direction of breakout (up or down)")
    print("3. üöÄ EXECUTE: Add aggressively in breakout direction")
    print("4. üéØ TARGET: 2-3% move minimum after breakout")
    print("5. ‚õî STOP: Opposite band becomes stop loss")
else:
    print("1. üëÄ MONITOR: Wait for bands to compress further")
    print("2. üìä PREPARE: Build USD reserves for breakout")

print("\nüî• THE SQUEEZE IS ON!")
print("=" * 60)