#!/usr/sbin/nft -f
#
# nftables firewall rules for Redfin (public-facing node)
# Cherokee AI Federation - Security Phase 3
# Generated: 2026-02-02
#
# REQUIRES ADMIN: Deploy with:
#   sudo cp /ganuda/config/nftables-redfin.conf /etc/nftables.conf
#   sudo systemctl restart nftables
#   sudo systemctl enable nftables

flush ruleset

table inet filter {

    # ---------------------------------------------------------------
    # Rate-limit sets
    # ---------------------------------------------------------------
    set ssh_meter {
        type ipv4_addr
        flags dynamic
        timeout 1m
    }

    set http_meter {
        type ipv4_addr
        flags dynamic
        timeout 1m
    }

    # ---------------------------------------------------------------
    # INPUT chain - default DROP
    # ---------------------------------------------------------------
    chain input {
        type filter hook input priority 0; policy drop;

        # --- Loopback ---
        iif "lo" accept

        # --- Connection tracking ---
        ct state established,related accept
        ct state invalid drop

        # --- ICMP (internal only) ---
        ip saddr 192.168.132.0/24 icmp type { echo-request, echo-reply, destination-unreachable, time-exceeded } accept

        # --- SSH (internal only, rate limited) ---
        ip saddr 192.168.132.0/24 tcp dport 22 ct state new \
            add @ssh_meter { ip saddr limit rate 3/minute burst 5 packets } accept
        ip saddr 192.168.132.0/24 tcp dport 22 ct state new \
            log prefix "[nft-ssh-ratelimit] " drop

        # --- HTTP/HTTPS (public, rate limited) ---
        tcp dport { 80, 443 } ct state new \
            add @http_meter { ip saddr limit rate 100/minute burst 150 packets } accept
        tcp dport { 80, 443 } ct state new \
            log prefix "[nft-http-ratelimit] " drop

        # --- LLM Gateway 8080 (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 8080 accept

        # --- vLLM 8000 (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 8000 accept

        # --- Kanban 3001 (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 3001 accept

        # --- SAG 4000 (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 4000 accept

        # --- Log and drop everything else ---
        log prefix "[nft-input-drop] " flags all counter drop
    }

    # ---------------------------------------------------------------
    # FORWARD chain - default DROP (not a router)
    # ---------------------------------------------------------------
    chain forward {
        type filter hook forward priority 0; policy drop;
    }

    # ---------------------------------------------------------------
    # OUTPUT chain - allow all outbound
    # ---------------------------------------------------------------
    chain output {
        type filter hook output priority 0; policy accept;
    }
}
