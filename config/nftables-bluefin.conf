#!/usr/sbin/nft -f
#
# nftables firewall rules for Bluefin (database/monitoring node)
# Cherokee AI Federation - Security Phase 3
# Generated: 2026-02-02
#
# REQUIRES ADMIN: Deploy with:
#   sudo cp /ganuda/config/nftables-bluefin.conf /etc/nftables.conf
#   sudo systemctl restart nftables
#   sudo systemctl enable nftables

flush ruleset

table inet filter {

    # ---------------------------------------------------------------
    # Rate-limit sets
    # ---------------------------------------------------------------
    set ssh_meter {
        type ipv4_addr
        flags dynamic
        timeout 1m
    }

    set pg_meter {
        type ipv4_addr
        flags dynamic
        timeout 1m
    }

    # ---------------------------------------------------------------
    # INPUT chain - default DROP
    # ---------------------------------------------------------------
    chain input {
        type filter hook input priority 0; policy drop;

        # --- Loopback ---
        iif "lo" accept

        # --- Connection tracking ---
        ct state established,related accept
        ct state invalid drop

        # --- ICMP (internal only) ---
        ip saddr 192.168.132.0/24 icmp type { echo-request, echo-reply, destination-unreachable, time-exceeded } accept

        # --- SSH (internal only, rate limited) ---
        ip saddr 192.168.132.0/24 tcp dport 22 ct state new \
            add @ssh_meter { ip saddr limit rate 3/minute burst 5 packets } accept
        ip saddr 192.168.132.0/24 tcp dport 22 ct state new \
            log prefix "[nft-ssh-ratelimit] " drop

        # --- PostgreSQL 5432 (internal only, rate limited) ---
        ip saddr 192.168.132.0/24 tcp dport 5432 ct state new \
            add @pg_meter { ip saddr limit rate 50/minute burst 75 packets } accept
        ip saddr 192.168.132.0/24 tcp dport 5432 ct state new \
            log prefix "[nft-pg-ratelimit] " drop

        # --- Grafana 3000 (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 3000 accept

        # --- Log and drop everything else ---
        log prefix "[nft-input-drop] " flags all counter drop
    }

    # ---------------------------------------------------------------
    # FORWARD chain - default DROP
    # ---------------------------------------------------------------
    chain forward {
        type filter hook forward priority 0; policy drop;
    }

    # ---------------------------------------------------------------
    # OUTPUT chain - allow all outbound
    # ---------------------------------------------------------------
    chain output {
        type filter hook output priority 0; policy accept;
    }
}
