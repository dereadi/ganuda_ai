#!/usr/sbin/nft -f
#
# nftables firewall rules for Greenfin (monitoring/embedding node)
# Cherokee AI Federation - Security Phase 3
# Generated: 2026-02-12
#
# REQUIRES ADMIN: Deploy with:
#   sudo cp /ganuda/config/nftables-greenfin.conf /etc/nftables.conf
#   sudo systemctl restart nftables
#   sudo systemctl enable nftables

flush ruleset

table inet filter {

    # ---------------------------------------------------------------
    # Rate-limit sets
    # ---------------------------------------------------------------
    set ssh_meter {
        type ipv4_addr
        flags dynamic
        timeout 1m
    }

    # ---------------------------------------------------------------
    # INPUT chain - default DROP
    # ---------------------------------------------------------------
    chain input {
        type filter hook input priority 0; policy drop;

        # --- Loopback ---
        iif "lo" accept

        # --- Connection tracking ---
        ct state established,related accept
        ct state invalid drop

        # --- ICMP (internal only) ---
        ip saddr 192.168.132.0/24 icmp type { echo-request, echo-reply, destination-unreachable, time-exceeded } accept

        # --- SSH (internal only, rate limited) ---
        ip saddr 192.168.132.0/24 tcp dport 22 ct state new \
            add @ssh_meter { ip saddr limit rate 3/minute burst 5 packets } accept
        ip saddr 192.168.132.0/24 tcp dport 22 ct state new \
            log prefix "[nft-ssh-ratelimit] " drop

        # --- OpenObserve 5080 web UI (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 5080 accept
        # --- OpenObserve 5081 gRPC ingest (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 5081 accept
        # --- Promtail 9080 (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 9080 accept
        # --- Embedding Server 8003 BGE-large (internal only) ---
        ip saddr 192.168.132.0/24 tcp dport 8003 accept

        # --- Camera Tunnel Ports (garage cam via WiFi bridge) ---
        ip saddr 192.168.132.0/24 tcp dport 18080 accept
        ip saddr 192.168.132.0/24 tcp dport 10554 accept

        # --- Solix Monitor 8443 (if needed for future MQTT proxy) ---
        # ip saddr 192.168.132.0/24 tcp dport 8443 accept

        # --- WiFi camera subnet ICMP ---
        ip saddr 10.0.0.0/24 icmp type { echo-request, echo-reply } accept

        # --- Log and drop everything else ---
        log prefix "[nft-input-drop] " flags all counter drop
    }

    # ---------------------------------------------------------------
    # FORWARD chain - allow camera tunnel traffic
    # ---------------------------------------------------------------
    chain forward {
        type filter hook forward priority 0; policy drop;

        # Allow established/related forwarded connections
        ct state established,related accept

        # Allow internal LAN → camera subnet (DNAT'd packets)
        ip saddr 192.168.132.0/24 ip daddr 10.0.0.123 accept

        # Allow camera responses back
        ip saddr 10.0.0.123 ip daddr 192.168.132.0/24 accept

        # FreeIPA (VLAN 10) access from federation nodes (VLAN 132)
        ip saddr 192.168.132.0/24 ip daddr 192.168.10.0/24 tcp dport { 88, 389, 636, 443 } accept
        ip saddr 192.168.132.0/24 ip daddr 192.168.10.0/24 udp dport { 88, 53 } accept
    }

    # ---------------------------------------------------------------
    # OUTPUT chain - allow all outbound
    # ---------------------------------------------------------------
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# ==================================================================
# NAT table — Camera tunnel (garage cam on WiFi subnet)
# Bridges 192.168.132.0/24 (LAN) ↔ 10.0.0.123 (garage cam on WiFi)
# ==================================================================
table ip nat {

    chain prerouting {
        type nat hook prerouting priority -100; policy accept;

        # HTTP snapshot: LAN:18080 → garage cam:80
        ip saddr 192.168.132.0/24 tcp dport 18080 dnat to 10.0.0.123:80

        # RTSP video: LAN:10554 → garage cam:554
        ip saddr 192.168.132.0/24 tcp dport 10554 dnat to 10.0.0.123:554
        ip saddr 192.168.132.0/24 udp dport 10554 dnat to 10.0.0.123:554
    }

    chain postrouting {
        type nat hook postrouting priority 100; policy accept;

        # Masquerade so camera sees traffic from greenfin's WiFi IP
        ip daddr 10.0.0.123 masquerade
    }
}
