# JR 18: VetAssist Deployment to Bluefin

**Date:** December 27, 2025
**Priority:** CRITICAL - Blocking MVP Launch
**Platform:** Bluefin (192.168.132.222)
**Estimated Time:** 2-3 hours
**Dependencies:** JRs 14-17, 19-21 COMPLETE

---

## Current Status

| Component | Status |
|-----------|--------|
| Database | NOT INITIALIZED |
| Backend venv | NOT CREATED |
| Frontend node_modules | NOT INSTALLED |
| Systemd services | NOT CREATED |
| Nginx config | NOT CREATED |

---

## Deployment Checklist

### Phase 1: Database Initialization

**Location:** Bluefin via SSH

```bash
# SSH to Bluefin
ssh bluefin

# 1. Create database and user
sudo -u postgres psql << 'EOF'
-- Create user
CREATE USER vetassist_user WITH PASSWORD 'VetAssist2025!Ganuda';

-- Create database
CREATE DATABASE vetassist OWNER vetassist_user;

-- Grant privileges
GRANT ALL PRIVILEGES ON DATABASE vetassist TO vetassist_user;

-- Enable pgvector extension
\c vetassist
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Grant schema privileges
GRANT ALL ON SCHEMA public TO vetassist_user;
EOF

# 2. Initialize schema
cd /ganuda/vetassist/database
psql -U vetassist_user -d vetassist -f schema.sql

# 3. Seed VA compensation rates
psql -U vetassist_user -d vetassist -f seed_va_rates.sql

# 4. Seed educational content
psql -U vetassist_user -d vetassist -f seed_content.sql

# 5. Verify
psql -U vetassist_user -d vetassist -c "SELECT COUNT(*) as rate_count FROM va_compensation_rates;"
psql -U vetassist_user -d vetassist -c "SELECT COUNT(*) as content_count FROM educational_content;"
```

**Success Criteria:**
- [ ] Database `vetassist` exists
- [ ] User `vetassist_user` can connect
- [ ] Tables created (users, chat_sessions, chat_messages, etc.)
- [ ] VA compensation rates seeded (should have 2024/2025 rates)
- [ ] Educational content seeded (9+ articles)

---

### Phase 2: Backend Deployment

**Location:** `/ganuda/vetassist/backend`

```bash
cd /ganuda/vetassist/backend

# 1. Create Python virtual environment
python3 -m venv venv
source venv/bin/activate

# 2. Install dependencies
pip install --upgrade pip
pip install -r requirements.txt

# 3. Create .env file
cat > .env << 'EOF'
# VetAssist Backend Configuration
# Generated by JR 18 Deployment

# Database
DATABASE_URL=postgresql://vetassist_user:VetAssist2025!Ganuda@localhost:5432/vetassist

# Security - CHANGE IN PRODUCTION
SECRET_KEY=VetAssistGanuda2025SecretKeyFor7Generations!ChangeMe
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# API Settings
API_V1_STR=/api/v1
PROJECT_NAME=VetAssist

# CORS
CORS_ORIGINS=["http://localhost:3000","http://bluefin:3000","http://192.168.132.222:3000","http://vetassist.ganuda.local"]

# Council/LLM Integration
VLLM_API_URL=http://redfin:8000/v1
COUNCIL_ENABLED=true

# Environment
ENVIRONMENT=staging
DEBUG=false
EOF

# 4. Test backend starts
uvicorn app.main:app --host 0.0.0.0 --port 8001 --workers 1

# 5. Test health endpoint (from another terminal)
curl http://localhost:8001/health
curl http://localhost:8001/api/v1/calculator/health
```

**Success Criteria:**
- [ ] venv created with all dependencies
- [ ] .env configured with correct DATABASE_URL
- [ ] Backend starts without errors on port 8001
- [ ] Health endpoint returns 200 OK
- [ ] Calculator endpoint returns valid response

---

### Phase 3: Frontend Deployment

**Location:** `/ganuda/vetassist/frontend`

```bash
cd /ganuda/vetassist/frontend

# 1. Install Node.js dependencies
npm install

# 2. Create .env.local
cat > .env.local << 'EOF'
# VetAssist Frontend Configuration

# API URL - points to backend
NEXT_PUBLIC_API_URL=http://192.168.132.222:8001/api/v1

# App Settings
NEXT_PUBLIC_APP_NAME=VetAssist
NEXT_PUBLIC_APP_VERSION=1.0.0-mvp
EOF

# 3. Build production bundle
npm run build

# 4. Test frontend starts
npm run start

# 5. Test from another terminal
curl http://localhost:3000/
```

**Success Criteria:**
- [ ] node_modules installed
- [ ] .env.local configured with API URL
- [ ] Production build completes without errors
- [ ] Frontend starts on port 3000
- [ ] Homepage renders correctly

---

### Phase 4: Systemd Service Files

**Create Backend Service:**

```bash
sudo cat > /etc/systemd/system/vetassist-backend.service << 'EOF'
[Unit]
Description=VetAssist Backend API
After=network.target postgresql.service
Wants=postgresql.service

[Service]
Type=simple
User=dereadi
Group=dereadi
WorkingDirectory=/ganuda/vetassist/backend
Environment="PATH=/ganuda/vetassist/backend/venv/bin"
ExecStart=/ganuda/vetassist/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8001 --workers 2
Restart=always
RestartSec=5

# Security hardening
NoNewPrivileges=true
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF
```

**Create Frontend Service:**

```bash
sudo cat > /etc/systemd/system/vetassist-frontend.service << 'EOF'
[Unit]
Description=VetAssist Frontend (Next.js)
After=network.target vetassist-backend.service
Wants=vetassist-backend.service

[Service]
Type=simple
User=dereadi
Group=dereadi
WorkingDirectory=/ganuda/vetassist/frontend
ExecStart=/usr/bin/npm run start
Restart=always
RestartSec=5
Environment=NODE_ENV=production
Environment=PORT=3000

# Security hardening
NoNewPrivileges=true
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF
```

**Enable and Start Services:**

```bash
# Reload systemd
sudo systemctl daemon-reload

# Enable services to start on boot
sudo systemctl enable vetassist-backend
sudo systemctl enable vetassist-frontend

# Start services
sudo systemctl start vetassist-backend
sudo systemctl start vetassist-frontend

# Check status
sudo systemctl status vetassist-backend
sudo systemctl status vetassist-frontend

# View logs if needed
sudo journalctl -u vetassist-backend -f
sudo journalctl -u vetassist-frontend -f
```

**Success Criteria:**
- [ ] Both service files created in /etc/systemd/system/
- [ ] Services enabled for auto-start
- [ ] Both services running (active)
- [ ] No errors in journalctl logs

---

### Phase 5: Nginx Reverse Proxy

```bash
# Create Nginx config
sudo cat > /etc/nginx/sites-available/vetassist << 'EOF'
# VetAssist - Ganuda VA Claims Assistance Platform
# Deployed by JR 18

upstream vetassist_backend {
    server 127.0.0.1:8001;
    keepalive 32;
}

upstream vetassist_frontend {
    server 127.0.0.1:3000;
    keepalive 32;
}

server {
    listen 80;
    server_name vetassist.ganuda.local 192.168.132.222;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Frontend - Next.js
    location / {
        proxy_pass http://vetassist_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
    }

    # Backend API
    location /api/ {
        proxy_pass http://vetassist_backend/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;  # Longer timeout for Council responses
        proxy_connect_timeout 60s;
    }

    # Health check endpoint
    location /health {
        proxy_pass http://vetassist_backend/health;
        proxy_http_version 1.1;
    }

    # Static files caching
    location /_next/static/ {
        proxy_pass http://vetassist_frontend/_next/static/;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "public, immutable";
    }

    # Logs
    access_log /var/log/nginx/vetassist_access.log;
    error_log /var/log/nginx/vetassist_error.log;
}
EOF

# Enable site
sudo ln -sf /etc/nginx/sites-available/vetassist /etc/nginx/sites-enabled/vetassist

# Test nginx config
sudo nginx -t

# Reload nginx
sudo systemctl reload nginx
```

**Success Criteria:**
- [ ] Nginx config created and symlinked
- [ ] `nginx -t` passes validation
- [ ] Nginx reloaded without errors
- [ ] Site accessible at http://192.168.132.222/

---

### Phase 6: Smoke Tests

**Create Smoke Test Script:**

```bash
cat > /ganuda/vetassist/test_deployment.sh << 'EOF'
#!/bin/bash
# VetAssist Deployment Smoke Test
# JR 18 - December 2025

set -e

echo "=========================================="
echo "VetAssist Deployment Smoke Test"
echo "=========================================="
echo ""

PASS=0
FAIL=0

# Color codes
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

test_result() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}[PASS]${NC} $2"
        ((PASS++))
    else
        echo -e "${RED}[FAIL]${NC} $2"
        ((FAIL++))
    fi
}

echo "1. Testing Database Connection..."
psql -U vetassist_user -d vetassist -c "SELECT 1;" > /dev/null 2>&1
test_result $? "Database connection"

echo "2. Testing VA Rates Table..."
COUNT=$(psql -U vetassist_user -d vetassist -t -c "SELECT COUNT(*) FROM va_compensation_rates;" 2>/dev/null | tr -d ' ')
[ "$COUNT" -gt 0 ] 2>/dev/null
test_result $? "VA compensation rates loaded ($COUNT rows)"

echo "3. Testing Educational Content..."
COUNT=$(psql -U vetassist_user -d vetassist -t -c "SELECT COUNT(*) FROM educational_content;" 2>/dev/null | tr -d ' ')
[ "$COUNT" -gt 0 ] 2>/dev/null
test_result $? "Educational content loaded ($COUNT articles)"

echo "4. Testing Backend Health..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/health)
[ "$HTTP_CODE" = "200" ]
test_result $? "Backend health endpoint (HTTP $HTTP_CODE)"

echo "5. Testing Calculator API..."
CALC_RESPONSE=$(curl -s -X POST http://localhost:8001/api/v1/calculator/calculate \
    -H "Content-Type: application/json" \
    -d '{"conditions": [{"name": "PTSD", "rating": 70}]}')
echo "$CALC_RESPONSE" | grep -q "combined_rating"
test_result $? "Calculator API returns valid response"

echo "6. Testing Frontend..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/)
[ "$HTTP_CODE" = "200" ]
test_result $? "Frontend homepage (HTTP $HTTP_CODE)"

echo "7. Testing Nginx Proxy..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://192.168.132.222/)
[ "$HTTP_CODE" = "200" ]
test_result $? "Nginx proxy to frontend (HTTP $HTTP_CODE)"

echo "8. Testing API via Nginx..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://192.168.132.222/api/v1/calculator/health)
[ "$HTTP_CODE" = "200" ]
test_result $? "Nginx proxy to API (HTTP $HTTP_CODE)"

echo "9. Testing Systemd Services..."
systemctl is-active --quiet vetassist-backend
test_result $? "vetassist-backend service active"

systemctl is-active --quiet vetassist-frontend
test_result $? "vetassist-frontend service active"

echo ""
echo "=========================================="
echo "Results: $PASS passed, $FAIL failed"
echo "=========================================="

if [ $FAIL -gt 0 ]; then
    echo -e "${RED}DEPLOYMENT INCOMPLETE - Fix failures above${NC}"
    exit 1
else
    echo -e "${GREEN}DEPLOYMENT SUCCESSFUL!${NC}"
    echo ""
    echo "VetAssist is now available at:"
    echo "  - http://192.168.132.222/"
    echo "  - http://vetassist.ganuda.local/ (if DNS configured)"
    echo ""
    echo "API Documentation:"
    echo "  - http://192.168.132.222/api/v1/docs"
    exit 0
fi
EOF

chmod +x /ganuda/vetassist/test_deployment.sh
```

**Run Smoke Tests:**

```bash
/ganuda/vetassist/test_deployment.sh
```

**Success Criteria:**
- [ ] All 10 tests pass
- [ ] No errors in output
- [ ] Site accessible from other machines on network

---

## Deliverables Checklist

| Deliverable | Status |
|-------------|--------|
| PostgreSQL database `vetassist` created | [ ] |
| VA compensation rates seeded | [ ] |
| Educational content seeded | [ ] |
| Backend venv with dependencies | [ ] |
| Backend .env configured | [ ] |
| Frontend node_modules installed | [ ] |
| Frontend .env.local configured | [ ] |
| Frontend production build complete | [ ] |
| vetassist-backend.service created | [ ] |
| vetassist-frontend.service created | [ ] |
| Services enabled and running | [ ] |
| Nginx config created and enabled | [ ] |
| Smoke test script created | [ ] |
| All smoke tests passing | [ ] |

---

## Rollback Procedure

If deployment fails:

```bash
# Stop services
sudo systemctl stop vetassist-frontend vetassist-backend

# Disable services
sudo systemctl disable vetassist-frontend vetassist-backend

# Remove nginx config
sudo rm /etc/nginx/sites-enabled/vetassist
sudo systemctl reload nginx

# Drop database (CAUTION - destroys data)
sudo -u postgres psql -c "DROP DATABASE vetassist;"
sudo -u postgres psql -c "DROP USER vetassist_user;"
```

---

## Post-Deployment

After successful deployment:

1. **Update thermal memory** with deployment status
2. **Notify Big Mac** that deployment is complete
3. **Create deployment documentation** at `/ganuda/vetassist/docs/DEPLOYMENT.md`
4. **Add to monitoring** (if Ganuda monitoring exists)

---

## Contact

**TPM:** Big Mac
**Platform:** Bluefin (192.168.132.222)
**Project:** VetAssist MVP

**For the Seven Generations.**
