---
# Cherokee AI Federation — Auto-Generated Service Restart Playbook
# Generated by remediation engine for alert {{ alert_id }}
# Category: service_down
# Target: {{ target_node }} / {{ target_service }}
#
# HUMAN-READABLE (Turtle's 7GEN): This playbook restarts a crashed
# service after verifying the node is reachable and checking disk space.
- name: "Remediate service_down: {{ target_service }} on {{ target_node }}"
  hosts: "{{ target_node }}"
  become: yes
  gather_facts: yes

  tasks:
    - name: Check disk space is not critically low
      assert:
        that:
          - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first > 1073741824
        fail_msg: "Root filesystem has less than 1GB free — manual intervention required"
        success_msg: "Disk space OK"

    - name: Check if service unit file exists
      stat:
        path: "/etc/systemd/system/{{ target_service }}"
      register: unit_file

    - name: Fail if service unit not found
      assert:
        that: unit_file.stat.exists
        fail_msg: "Service unit {{ target_service }} not found on {{ target_node }}"

    - name: Restart the failed service
      systemd:
        name: "{{ target_service }}"
        state: restarted
        daemon_reload: yes

    - name: Wait for service to stabilize (10 seconds)
      pause:
        seconds: 10

    - name: Verify service is running
      systemd:
        name: "{{ target_service }}"
      register: service_status

    - name: Report service status
      debug:
        msg: >-
          {{ target_service }} on {{ target_node }}:
          {{ 'RUNNING' if service_status.status.ActiveState == 'active' else 'FAILED — escalate to TPM' }}

    - name: Fail if service did not recover
      assert:
        that: service_status.status.ActiveState == 'active'
        fail_msg: "Service {{ target_service }} failed to restart — requires TPM intervention"