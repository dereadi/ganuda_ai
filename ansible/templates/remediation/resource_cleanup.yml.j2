---
# Cherokee AI Federation â€” Auto-Generated Resource Cleanup Playbook
# Generated by remediation engine for alert {{ alert_id }}
# Category: resource_exhaustion
# Target: {{ target_node }}
#
# HUMAN-READABLE (Turtle's 7GEN): This playbook cleans up common
# space consumers (logs, pycache, temp files) when disk usage is critical.
- name: "Remediate resource_exhaustion on {{ target_node }}"
  hosts: "{{ target_node }}"
  become: yes
  gather_facts: yes

  tasks:
    - name: Report current disk usage
      debug:
        msg: >-
          Root filesystem: {{ (ansible_mounts | selectattr('mount', 'equalto', '/') | first).size_available | human_readable }}
          available of {{ (ansible_mounts | selectattr('mount', 'equalto', '/') | first).size_total | human_readable }}

    - name: Clean systemd journal (older than 3 days)
      command: journalctl --vacuum-time=3d
      changed_when: true

    - name: Remove Python __pycache__ directories under /ganuda
      command: find /ganuda -type d -name __pycache__ -exec rm -rf {} +
      changed_when: true
      ignore_errors: yes

    - name: Clean apt cache
      apt:
        autoclean: yes
        autoremove: yes
      when: ansible_os_family == 'Debian'

    - name: Report disk usage after cleanup
      command: df -h /
      register: df_result
      changed_when: false

    - name: Show cleanup result
      debug:
        msg: "{{ df_result.stdout }}"