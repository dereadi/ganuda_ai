---
# Cherokee AI Federation — Auto-Generated Config Drift Remediation
# Generated by remediation engine for alert {{ alert_id }}
# Category: config_drift
# Target: {{ target_node }} / {{ config_path }}
#
# HUMAN-READABLE (Turtle's 7GEN): This playbook restores a drifted
# config file from the git-tracked version in /ganuda/config/.
- name: "Remediate config_drift: {{ config_path }} on {{ target_node }}"
  hosts: "{{ target_node }}"
  become: yes
  gather_facts: no

  tasks:
    - name: Backup current (drifted) config
      copy:
        src: "{{ config_path }}"
        dest: "{{ config_path }}.drift_backup_{{ ansible_date_time.iso8601_basic_short | default('unknown') }}"
        remote_src: yes
      ignore_errors: yes

    - name: Restore config from ganuda source
      copy:
        src: "{{ ganuda_source_path }}"
        dest: "{{ config_path }}"
        owner: "{{ config_owner | default('root') }}"
        group: "{{ config_group | default('root') }}"
        mode: "{{ config_mode | default('0644') }}"
      notify: "reload {{ affected_service | default('nothing') }}"

    - name: Verify restored config syntax
      command: "{{ validation_command }}"
      register: syntax_check
      changed_when: false
      when: validation_command is defined

    - name: Report restoration result
      debug:
        msg: "Config {{ config_path }} restored from {{ ganuda_source_path }} — syntax check: {{ syntax_check.stdout | default('skipped') }}"

  handlers:
    - name: "reload {{ affected_service | default('nothing') }}"
      systemd:
        name: "{{ affected_service }}"
        state: reloaded
      when: affected_service is defined