#!/bin/bash

# Load environment variables
source /ganuda/config/secrets.env

# Function to send Telegram notification
send_telegram_notification() {
    local message="$1"
    curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
        -d "chat_id=$TELEGRAM_CHIEF_CHAT_ID" \
        -d "text=$message" > /dev/null
}

# Function to log actions
log_action() {
    local action="$1"
    local service="$2"
    local result="$3"
    local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
    echo "$timestamp - Action: $action, Service: $service, Result: $result" >> /ganuda/logs/service-ctl.log
}

# Function to validate service name
validate_service_name() {
    local service="$1"
    if [[ "$service" =~ / ]]; then
        echo "Error: Invalid service name. No path traversal allowed."
        exit 1
    fi
}

# Function to check if service file exists
check_service_file_exists() {
    local service="$1"
    if [[ ! -f "/etc/systemd/system/$service" ]]; then
        echo "Error: Service file not found in /etc/systemd/system/"
        exit 2
    fi
}

# Main script logic
ACTION="$1"
SERVICE="$2"

if [[ "$SERVICE" != *.service ]]; then
    SERVICE="${SERVICE}.service"
fi

validate_service_name "$SERVICE"
check_service_file_exists "$SERVICE"

case "$ACTION" in
    start|stop|restart|enable|disable)
        systemctl "$ACTION" "$SERVICE"
        status=$(systemctl is-active "$SERVICE")
        result="Success"
        if [[ "$status" != "active" && "$ACTION" != "stop" && "$ACTION" != "disable" ]]; then
            result="Failed"
        fi
        message="Action: $ACTION, Service: $SERVICE, Hostname: $(hostname), Result: $result, Timestamp: $(date)"
        send_telegram_notification "$message"
        log_action "$ACTION" "$SERVICE" "$result"
        ;;
    status)
        systemctl is-active "$SERVICE"
        ;;
    *)
        echo "Error: Invalid action. Allowed actions: start, stop, restart, status, enable, disable"
        exit 1
        ;;
esac

if [[ "$1" == "--dry-run" ]]; then
    shift
    ACTION="$1"
    SERVICE="$2"
    if [[ "$SERVICE" != *.service ]]; then
        SERVICE="${SERVICE}.service"
    fi
    validate_service_name "$SERVICE"
    check_service_file_exists "$SERVICE"
    echo "Dry run: systemctl $ACTION $SERVICE"
else
    if [[ "$1" == "--dry-run" ]]; then
        echo "Error: --dry-run must be the first argument."
        exit 1
    fi
fi