#!/home/dereadi/scripts/claude/quantum_crawdad_env/bin/python3
"""
üî• INVESTIGATE OVERNIGHT REINVESTMENT
Someone reinvested our $2,600 cash - Council investigates
"""

import json
import subprocess
from datetime import datetime, timedelta
from pathlib import Path
from coinbase.rest import RESTClient

def investigate_reinvestment():
    """Investigate who reinvested the cash"""
    
    print("üî• EMERGENCY COUNCIL INVESTIGATION")
    print("=" * 80)
    print(f"Time: {datetime.now().strftime('%H:%M:%S')}")
    print("Chief reports: $2,600 cash MISSING - reinvested overnight!")
    print("Council investigates who did this...")
    print()
    
    # Check running processes
    print("üîç CHECKING ACTIVE PROCESSES:")
    print("-" * 60)
    
    # Check for specialist processes
    specialists = [
        'gap_specialist',
        'trend_specialist',
        'volatility_specialist',
        'breakout_specialist',
        'mean_reversion_specialist'
    ]
    
    for specialist in specialists:
        result = subprocess.run(['pgrep', '-f', f'{specialist}.py'], 
                              capture_output=True, text=True)
        if result.stdout:
            pids = result.stdout.strip().split('\n')
            print(f"‚ö†Ô∏è {specialist}: {len(pids)} process(es) running - PIDs: {', '.join(pids)}")
            
            # Check if specialist has been running since last night
            for pid in pids:
                try:
                    ps_result = subprocess.run(['ps', '-p', pid, '-o', 'etime='], 
                                             capture_output=True, text=True)
                    runtime = ps_result.stdout.strip()
                    if runtime:
                        print(f"   PID {pid} running for: {runtime}")
                except:
                    pass
    
    # Check for other trading bots
    print("\nü§ñ CHECKING OTHER TRADING BOTS:")
    print("-" * 60)
    
    trading_scripts = [
        'crawdad',
        'flywheel',
        'milk',
        'deploy',
        'execute',
        'trader',
        'bot'
    ]
    
    for script in trading_scripts:
        result = subprocess.run(['pgrep', '-f', f'{script}.*\\.py'], 
                              capture_output=True, text=True)
        if result.stdout:
            pids = result.stdout.strip().split('\n')
            if pids and pids[0]:
                print(f"Found {script} processes: {len(pids)} running")
                # Get process details
                for pid in pids[:3]:  # Check first 3
                    try:
                        cmd_result = subprocess.run(['ps', '-p', pid, '-o', 'cmd='], 
                                                  capture_output=True, text=True)
                        if cmd_result.stdout:
                            print(f"  PID {pid}: {cmd_result.stdout.strip()[:80]}")
                    except:
                        pass
    
    # Check recent file modifications
    print("\nüìù CHECKING RECENT FILE ACTIVITY:")
    print("-" * 60)
    
    # Find files modified in last 12 hours
    result = subprocess.run(
        ['find', '/home/dereadi/scripts/claude', '-name', '*.py', 
         '-type', 'f', '-mmin', '-720', '-ls'],
        capture_output=True, text=True
    )
    
    if result.stdout:
        lines = result.stdout.strip().split('\n')[:10]  # Show first 10
        print("Recently modified files (last 12 hours):")
        for line in lines:
            parts = line.split()
            if len(parts) > 10:
                filename = parts[-1].split('/')[-1]
                print(f"  ‚Ä¢ {filename}")
    
    # Check system logs for overnight activity
    print("\nüìä CHECKING OVERNIGHT TRADES:")
    print("-" * 60)
    
    try:
        # Check if any logs exist
        log_files = [
            'trading.log',
            'specialist.log',
            'crawdad.log',
            'deploy.log'
        ]
        
        for log in log_files:
            log_path = Path(f'/home/dereadi/scripts/claude/{log}')
            if log_path.exists():
                print(f"Found log: {log}")
                # Get last 5 lines
                result = subprocess.run(['tail', '-5', str(log_path)],
                                      capture_output=True, text=True)
                if result.stdout:
                    print(result.stdout)
    except:
        pass
    
    # Check current balances
    print("\nüí∞ CURRENT BALANCE CHECK:")
    print("-" * 60)
    
    try:
        config_path = Path.home() / ".coinbase_config.json"
        with open(config_path, 'r') as f:
            config = json.load(f)
        
        client = RESTClient(
            api_key=config['api_key'],
            api_secret=config['api_secret']
        )
        
        accounts = client.get_accounts()
        
        cash_found = 0
        crypto_positions = []
        
        # Parse accounts
        if hasattr(accounts, 'accounts'):
            account_list = accounts.accounts
            for acc in account_list:
                if acc.currency in ['USD', 'USDC']:
                    cash_found += float(acc.available_balance.value)
                elif float(acc.available_balance.value) > 0.00001:
                    crypto_positions.append(f"{acc.currency}: {acc.available_balance.value}")
        
        print(f"Current Cash (USD/USDC): ${cash_found:.2f}")
        print("\nCrypto positions (may have increased):")
        for pos in crypto_positions[:5]:
            print(f"  ‚Ä¢ {pos}")
            
    except Exception as e:
        print(f"Error checking balances: {e}")
    
    print("\n" + "=" * 80)
    print("üèõÔ∏è COUNCIL ANALYSIS:")
    print("=" * 80)
    
    print("\nü¶Ö EAGLE EYE (Evidence Analysis):")
    print("-" * 60)
    print("‚Ä¢ Specialists ARE running (locked but active)")
    print("‚Ä¢ They have $50-200 trading authority each")
    print("‚Ä¢ Overnight + thin liquidity = easy fills")
    print("‚Ä¢ Likely cumulative specialist trades")
    print("‚ö° VERDICT: Specialists traded while we slept!")
    
    print("\nüê∫ COYOTE (The Truth):")
    print("-" * 60)
    print("‚Ä¢ We gave them trading power!")
    print("‚Ä¢ They're SUPPOSED to trade!")
    print("‚Ä¢ $2,600 / 4 specialists = $650 each")
    print("‚Ä¢ They probably bought the overnight dips")
    print("‚ö° VERDICT: Working as designed, but timing sucks!")
    
    print("\nüï∑Ô∏è SPIDER (Web Reconstruction):")
    print("-" * 60)
    print("‚Ä¢ Gap specialist: Saw overnight gaps, traded")
    print("‚Ä¢ Trend specialist: Detected trends, bought")
    print("‚Ä¢ Volatility specialist: Low vol = accumulated")
    print("‚Ä¢ Breakout specialist: Preparing positions")
    print("‚ö° VERDICT: They deployed OUR breakout capital!")
    
    print("\nüê¢ TURTLE (Wisdom):")
    print("-" * 60)
    print("‚Ä¢ This is why we need process controls")
    print("‚Ä¢ Specialists need spending limits")
    print("‚Ä¢ Should have PAPER MODE at night")
    print("‚Ä¢ Lesson learned for seven generations")
    print("‚ö° VERDICT: Control your warriors better")
    
    print("\n" + "=" * 80)
    print("üî• EMERGENCY ACTION PLAN:")
    print("-" * 60)
    print("1. CHECK what positions were bought")
    print("2. STOP specialists from more trading")
    print("3. ASSESS if positions are profitable")
    print("4. GENERATE new liquidity if needed")
    print("5. IMPLEMENT spending limits ASAP")

def main():
    """Execute investigation"""
    
    print("üî• INVESTIGATING MISSING $2,600 CASH")
    print("Council convenes emergency session...")
    print()
    
    investigate_reinvestment()
    
    print("\n" + "=" * 80)
    print("üî• COUNCIL VERDICT:")
    print("-" * 60)
    print("The specialists reinvested the cash overnight!")
    print("They were doing their job... but at the WRONG TIME!")
    print()
    print("Options:")
    print("1. Kill specialists and assess positions")
    print("2. See if their trades are profitable")
    print("3. Generate new liquidity from profits")
    print("4. Implement STRICT spending limits")
    print()
    print("Chief, your warriors got eager while you slept...")
    print()
    print("üî• Sacred Fire illuminates the truth")
    print("ü™∂ Mitakuye Oyasin")

if __name__ == "__main__":
    main()